# PowerSync + Node.js + Railway Backend

## Overview
This repo contains a starter Node.js server application which has HTTP endpoints to authorize a [PowerSync](https://www.powersync.com/) enabled application to sync data between a client device and a PostgresSQL database. This repo is intended for use as a template on Railway.app.

The endpoints are as follows:

1. GET `/api/auth/token`

   - PowerSync uses this endpoint to retrieve a JWT access token which is used for authentication. 

2. GET `/api/auth/keys`

   - PowerSync uses this endpoint to validate the JWT returned from the endpoint above.

3. PUT `/api/data`

   - PowerSync uses this endpoint to sync upsert events that occurred on the client application.

4. PATCH `/api/data`

   - PowerSync uses this endpoint to sync update events that occurred on the client application.

5. DELETE `/api/data`

    - PowerSync uses this endpoint to sync delete events that occurred on the client application.

6. GET `/api/auth/token`
   -  PowerSync uses this endpoint to retrieve an JWT token that is generated by the server and is used to authenticate requests.
   
7. GET `api/auth/keys` 
   - PowerSync uses this endpoint to retrieve the JWK to validate the token provided in the response above.  

## Packages
- [node-postgres](https://github.com/brianc/node-postgres)  is used to interact with the Postgres database when a PowerSync enabled client performs requests to the `/api/data` endpoint.
- [jose](https://github.com/panva/jose) is used to sign the JWT which PowerSync uses for authorization.

## Setup

1. Clone the repository

2. Generate a new public/private key pair by running the following command:
```shell
yarn keys
```
This will output two new keys in the terminal window, make sure to copy and paste this into the env file below. These also need to be set on the Railway apps environment variables as:
```shell
POWERSYNC_JWT_PUBLICKEY
POWERSYNC_JWT_PRIVATEKEY
```
3. Create a new `.env` file in the root project directory and add the variables as defined in the `.env` file:
```shell
cp .env.template .env
```
4. Install dependencies:
```shell
nvm use
```
```shell
yarn install
```
## Start App
1. Run the following to start the application
```shell
yarn start
```
This will start the app on `http://127.0.0.1:PORT`, where PORT is what you specify in your `.env` file.

2. Test if the app is working by opening `http://127.0.0.1:PORT/api/auth/token/` in the browser

3. You should get a JSON object as the response to that request
